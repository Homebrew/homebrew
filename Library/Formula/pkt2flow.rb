require "formula"

class Pkt2flow < Formula
  homepage "https://github.com/isotopp/pkt2flow"
  # actual url https://github.com/yalla/pkt2flow/releases...
  # waiting for my changes to be accepted.
  url "https://github.com/isotopp/pkt2flow/archive/v1.5.tar.gz"
  sha1 "53b7c3786ba04377a2f00ba9234cc8e91a80b3b3"

  depends_on "scons" => :build

  def install
    args = [ "--prefix=#{prefix}"]

    scons 'pkt2flow'
    scons 'install', *args
  end

  test do
    expected_checksum = '6e02252518c56ebb799e5d055eba7224959cf67e'
    (testpath/'capture.uue').write('begin-base64 644 capture
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
AA==
====')
    system 'uudecode', '-m', 'capture.uue'
    system 'mkdir', 'x'
    system "#{bin}/pkt2flow -o x capture"
    system 'ls -1R x | shasum > checksum.txt'
    open('checksum.txt') do |f|
      checksum = f.read(100).split(' ').first.strip
      assert_equal checksum, expected_checksum
    end
  end
end
