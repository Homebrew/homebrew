#!/bin/sh

realpath()
# A fast, pared-down shell implementation of GNU `readlink -f`.
# This is needed to fully dereference and canonicalize the relevant paths.
# A full version of this is included in `brew shellutils`.
{
  rl_rl()
  {
    rl_rl="$(ls -ld "$*" | sed 's|.* -> ||')"
    [ "$(echo "$rl_rl" | cut -c1)" != "/" ] && rl_rl="$(pwd -P)/$rl_rl"
    echo "$rl_rl"
  }

  rl_canonicalize()
  {
    [ "$(basename "$*")"- = "."- ] || [ -"$(basename "$*")"- = -".."- ] &&
      rl_canon=$(cd "$(pwd -P)/$(basename "$*")"; pwd -P) ||
      rl_canon=$(echo $(pwd -P)/$(basename "$*") | sed 's|//|/|g')
    rl_canonical=$(echo "$rl_canon" | sed 's|//|/|g')
    echo "$rl_canonical"
  }

  rl_no_dir()
  {
    echo "$*" && return 0
  }

  rl_not_link()
  {
    rl_canonicalize "$*" && exit 0
  }

  rl_try(){
    rl_cur_dir=$(dirname "$*")
    rl_cur_base=$(basename "$*")

    cd "$rl_cur_dir" 2>/dev/null || rl_no_dir "$*"
    [ -e "$rl_cur_base" ] || rl_canonicalize "$(pwd -P)/$*"
    [ -L "$rl_cur_base" ] || rl_not_link "$*"

    rl_rl=$(rl_rl "$rl_cur_base")
    rl_try "$rl_rl"
  }

  rl_try "$*"
}

HOMEBREW_BREW_FILE=$(realpath "$0")
BREW_FILE_DIRECTORY=$(dirname "$HOMEBREW_BREW_FILE")
BREW_LIBRARY_DIRECTORY="$(cd "$BREW_FILE_DIRECTORY/../Library"; pwd -P)"
HOMEBREW_PREFIX=$(dirname "$BREW_FILE_DIRECTORY")

export BREW_FILE_DIRECTORY
export BREW_LIBRARY_DIRECTORY
export HOMEBREW_PREFIX
export HOMEBREW_BREW_FILE

case "$1" in

          update) shift
              exec "$BREW_LIBRARY_DIRECTORY/Homebrew/cmd/update"     "$@" ;;

      shellutils) shift
              exec "$BREW_LIBRARY_DIRECTORY/Homebrew/cmd/shellutils" "$@" ;;

        --prefix) shift
              [ $# -eq 0 ] && echo $HOMEBREW_PREFIX && exit 0

              for each in "$@"; do
                incellar=$(ls -1d $HOMEBREW_PREFIX/Cellar/$each/* 2>/dev/null)
                [ -z "$incellar" ] && echo "$HOMEBREW_PREFIX/opt/$each" ||
                  echo "$cellar"
                shift
              done

              exit 0 ;;

           *) tapcommand=$(ls $HOMEBREW_PREFIX/*/*/*/*/*/brew-$1 2>/dev/null)
              [ ! -z $tapcommand ] && shift && exec "$tapcommand" "$@"

              externalcommand=$(which brew-$1) && shift &&
                exec "$externalcommand" "$@" || continue ;;

        ''|*) continue ;;
esac

# Users may have these set, pointing the system Ruby at non-system gem paths
unset GEM_HOME
unset GEM_PATH

[ -z "$HOMEBREW_DEVELOPER" ] && unset HOMEBREW_RUBY_PATH
[ -z "$HOMEBREW_RUBY_PATH" ] && [ "$(uname)" = "Darwin" ] &&
 HOMEBREW_RUBY_PATH="/System/Library/Frameworks/Ruby.framework/Versions/Current/usr/bin/ruby" || HOMEBREW_RUBY_PATH="$(which ruby)"

export HOMEBREW_RUBY_PATH

exec "$HOMEBREW_RUBY_PATH" -W0 "$BREW_LIBRARY_DIRECTORY/brew.rb" "$@"
